rm(list=ls())
library(ggdist)
library(ggh4x)
library(reshape2)
library(SpatialSablefishAssessment)
library(tictoc)
library(doParallel)
library(pbapply)

# library(afscOM) # may work but not certain

# Change to wherever your local copy of afscOM is
library(devtools)
afscOM_dir <- "~/Desktop/Projects/afscOM" 
devtools::load_all(afscOM_dir)

# spatialSablefish_dir <- "~/Desktop/Projects/SpatialSablefishAssessment" 
# devtools::load_all(spatialSablefish_dir)

source("R/reference_points.R")
source("R/harvest_control_rules.R")
source("R/simulate_TAC.R")
source("R/age_structure_stats.R")
source("R/data_utils.R")
source("R/data_processing.R")
source("R/run_mse.R")
source("R/run_mse_parallel.R")
source("R/format_em_data.R")
source("R/fit_TMB_model.R")

#' 1. Set up the OM by defining demographic parameters
#' model options (such as options governing the observation
#' processes), and OM initial conditons
sable_om <- readRDS("data/sablefish_om.RDS") # Read this saved OM from a file
sable_om$model_options$simulate_observations <- TRUE # Enable simulating observations

# Generate age comp samples as integers rather than proportions
# (this is necesarry for the SpatialSablefishAssessment TMB model)
sable_om$model_options$obs_pars$surv_ll$as_integers = TRUE
sable_om$model_options$obs_pars$surv_tw$as_integers = TRUE
sable_om$model_options$obs_pars$fish_fx$as_integers = TRUE
sable_om$model_options$obs_pars$fish_tw$as_integers = TRUE
# Turn off estimation model
sable_om$model_options$run_estimation = FALSE

# OM with sex-spexific selectivity and small amount of observation error
om_sexed_small <- sable_om
om_sexed_small$model_options$obs_pars$surv_ll$ac_samps <- 100
om_sexed_small$model_options$obs_pars$surv_tw$ac_samps <- 100
om_sexed_small$model_options$obs_pars$fish_fx$ac_samps <- 100
om_sexed_small$model_options$obs_pars$fish_tw$ac_samps <- 100
om_sexed_small$model_options$obs_pars$surv_ll$rpn_cv <- 0.10
om_sexed_small$model_options$obs_pars$surv_ll$rpw_cv <- 0.10
om_sexed_small$model_options$obs_pars$surv_tw$rpw_cv <- 0.10

# OM with sex-spexific selectivity and small amount of observation error
om_sexed_medium <- sable_om
om_sexed_medium$model_options$obs_pars$surv_ll$ac_samps <- 50
om_sexed_medium$model_options$obs_pars$surv_tw$ac_samps <- 50
om_sexed_medium$model_options$obs_pars$fish_fx$ac_samps <- 50
om_sexed_medium$model_options$obs_pars$fish_tw$ac_samps <- 50
om_sexed_medium$model_options$obs_pars$surv_ll$rpn_cv <- 0.10
om_sexed_medium$model_options$obs_pars$surv_ll$rpw_cv <- 0.10
om_sexed_medium$model_options$obs_pars$surv_tw$rpw_cv <- 0.10

# OM with sex-spexific selectivity and large amount of observation error
om_sexed_large <- sable_om
om_sexed_large$model_options$obs_pars$surv_ll$ac_samps <- 30
om_sexed_large$model_options$obs_pars$surv_tw$ac_samps <- 30
om_sexed_large$model_options$obs_pars$fish_fx$ac_samps <- 30
om_sexed_large$model_options$obs_pars$fish_tw$ac_samps <- 30
om_sexed_large$model_options$obs_pars$surv_ll$rpn_cv <- 0.10
om_sexed_large$model_options$obs_pars$surv_ll$rpw_cv <- 0.10
om_sexed_large$model_options$obs_pars$surv_tw$rpw_cv <- 0.10



#' 2. Define a harvest control rule (HCR) function to use to project TAC
#' in future years. Such function must take accept the following parameters:
#' ref_pts: a list of reference points as generated by `calculate_ref_points`,
#'          (B40, F35, and F40)
#' naa: a vector of numbers-at-age for a given year (should be [1, nages, nsexes, nregions])
#' dem_params: a list of demographic parameter values subsetted to a single year
#' 
#' HCR functions can accept as many additional parameters as required.
#' 
#' Below is an example implementation of the NPFMCs Tier 3a HCR     
tier3 <- function(ref_pts, naa, dem_params){
    ssb <- apply(naa[,,1,]*dem_params$waa[,,1,,drop=FALSE]*dem_params$mat[,,1,,drop=FALSE], 1, sum)
    return(
        npfmc_tier3_F(ssb, ref_pts$B40, ref_pts$F40)
    )
}

#' 3. Run a lot of OM projections
#' A single OM simulation can be run using the `run_mse(...)`
#' function with om$model_options$run_estimation = FALSE, 
#' while multiple MSE simulations can be run (serially)
#' using the `run_mse_multiple(...)` function.
#' 
#' It is recommended to always use `run_mse_multiple(...)` even
#' when only a single MSE simulation is required.
set.seed(2023)
nsims <- 50
seeds <- sample(1:(1000*nsims), nsims)  # Draw 50 random seeds


mse_sexed_small     <- run_mse_parallel(nsims=nsims, seeds=seeds, nyears=160, om=om_sexed_small,  hcr=tier3)
mse_sexed_medium    <- run_mse_parallel(nsims=nsims, seeds=seeds, nyears=160, om=om_sexed_medium, hcr=tier3)
mse_sexed_large     <- run_mse_parallel(nsims=nsims, seeds=seeds, nyears=160, om=om_sexed_large,  hcr=tier3)

####
nyears <- 160

#' 4. Apply the TMB fitting procedure to the observation data
#' Use fit_TMB_model(...) to fit the EM to the generated 
#' observations from each of the MSEs in the terminal year of
#' the OM projection.
#' 
#' This is being done in parallele using pbapply::pblapply(...) 
cores <- parallel::detectCores()-2
cl <- parallel::makeCluster(cores, outfile="")
registerDoParallel(cl)

assess_ssb_agg_sxsm <- pbapply::pblapply(1:nsims, function(s, sable_om, mse_tier3, nyears, om){
    library(devtools)
    library(tidyverse)
    library(TMB) 

    afscOM_dir <- "~/Desktop/Projects/afscOM"
    devtools::load_all(afscOM_dir)

    source("R/format_em_data.R")
    source("R/fit_TMB_model.R")
    source("R/reference_points.R")
    source("R/run_em.r")
    assess_ssb <- run_EM(s, sable_om, mse_tier3, nyears, om_name=om, model_name="CurrentAssessmentDisaggregated")
    return(assess_ssb)
}, sable_om=om_sexed_small, mse_tier3=mse_sexed_small, nyears=nyears, om="sxsm", cl=cl)
assess_ssb_agg_sxsm <- bind_rows(assess_ssb_agg_sxsm)

assess_ssb_agg_sxmd <- pbapply::pblapply(1:nsims, function(s, sable_om, mse_tier3, nyears, om){
    library(devtools)
    library(tidyverse)
    library(TMB) 

    afscOM_dir <- "~/Desktop/Projects/afscOM"
    devtools::load_all(afscOM_dir)

    source("R/format_em_data.R")
    source("R/fit_TMB_model.R")
    source("R/reference_points.R")
    source("R/run_em.r")
    assess_ssb <- run_EM(s, sable_om, mse_tier3, nyears, om_name=om, model_name="CurrentAssessmentDisaggregated")

    return(assess_ssb)
}, sable_om=om_sexed_medium, mse_tier3=mse_sexed_medium, nyears=nyears, om="sxmd", cl=cl)
assess_ssb_agg_sxmd <- bind_rows(assess_ssb_agg_sxmd)

assess_ssb_agg_sxlg <- pbapply::pblapply(1:nsims, function(s, sable_om, mse_tier3, nyears, om){
    library(devtools)
    library(tidyverse)
    library(TMB) 

    afscOM_dir <- "~/Desktop/Projects/afscOM"
    devtools::load_all(afscOM_dir)

    source("R/format_em_data.R")
    source("R/fit_TMB_model.R")
    source("R/reference_points.R")
    source("R/run_em.r")
    assess_ssb <- run_EM(s, sable_om, mse_tier3, nyears, om_name=om, model_name="CurrentAssessmentDisaggregated")

    return(assess_ssb)
}, sable_om=om_sexed_large, mse_tier3=mse_sexed_large, nyears=nyears, om="sxlg", cl=cl)
assess_ssb_agg_sxlg <- bind_rows(assess_ssb_agg_sxlg)


stopCluster(cl)

#' 5. Process EM fits and compute relative error
data <- bind_rows(assess_ssb_agg_sxsm, assess_ssb_agg_sxmd, assess_ssb_agg_sxlg)

rel_error <- data %>% as_tibble() %>%
  pivot_longer(-c(Year, sim, om), values_to="value", names_to="quantity") %>%
  rename(om_name=om) %>%
  filter(!(quantity %in% c("M", "ll_q", "tw_q"))) %>%
  separate(quantity, c("model", "quantity"), extra = "merge") %>%
  pivot_wider(names_from="model", values_from="value") %>%
  mutate(
    rel_error = (est-om)/om
  ) %>%
  select(Year, sim, om_name, quantity, rel_error) %>%
  pivot_wider(names_from="quantity", values_from="rel_error") %>%
  group_by(Year, om_name) %>%
  median_qi(rec, ssb, F, B40, F40, F35, .width=c(0.50, 0.80)) %>%
  reformat_ggdist_long(2) %>%
  mutate(
    name = factor(name, levels=c("ssb", "F", "rec", "ll_f", "tw_f", "F35", "F40", "B40")),
    om_name = factor(om_name, levels=c("sxsm", "sxmd", "sxlg"))
  )

avg_rel_error <- rel_error %>% 
  group_by(om_name, name) %>% 
  summarise(avg = median(median[Year > 2022])) %>%
  mutate(
    text_y = case_when(
      name == "ssb" ~ 0.085,
      name == "F" ~ 0.30,
      name == "rec" ~ 0.375,
      name == "ll_f" ~ 0.30,
      name == "tw_f" ~ 0.30,
      name == "F35" ~ 0.04,
      name == "F40" ~ 0.04,
      name == "B40" ~ 0.04,
    )
  )

ggplot(rel_error)+
  geom_lineribbon(aes(x=Year, y=median, ymin=lower, ymax=upper), size=0.6)+
  geom_vline(xintercept=2022)+
  geom_hline(data=avg_rel_error, aes(yintercept=avg), linetype="solid", color="red", size=0.6) + 
  geom_hline(yintercept=0.0, size=1)+
  geom_text(data=avg_rel_error, aes(x=2100, y=text_y, label=paste0(round(100*avg, 3), "%")), color="red")+
  scale_fill_brewer()+
  facet_grid(rows=vars(name), cols=vars(om_name), scales="free_y")+
  facetted_pos_scales(
      y=list(
          scale_y_continuous(limits=c(-0.12, 0.12)),
          scale_y_continuous(limits=c(-0.05, 0.35)),
          scale_y_continuous(limits=c(-0.5, 0.5)),
          scale_y_continuous(limits=c(-0.05, 0.35)),
          scale_y_continuous(limits=c(-0.05, 0.35)),
          scale_y_continuous(limits=c(-0.05, 0.05)),
          scale_y_continuous(limits=c(-0.05, 0.05)),
          scale_y_continuous(limits=c(-0.05, 0.05))
      )
  )+
  theme_bw()

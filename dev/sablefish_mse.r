rm(list=ls())

library(tidyverse)
library(ggdist)
library(ggh4x)
library(reshape2)
library(SpatialSablefishAssessment)
library(tictoc)
library(doParallel)
# library(afscOM)
# library(afscOM) # may work but not certain

# Change to wherever your local copy of afscOM is
library(devtools)
afscOM_dir <- "~/Desktop/Projects/afscOM"
sablefishMSE_dir <- here::here()

devtools::load_all(afscOM_dir)
# devtools::load_all(sablefishMSE_dir)

lapply(list.files("R", full.names = TRUE), source)

#' 1. Set up the OM by defining demographic parameters
#' model options (such as options governing the observation
#' processes), and OM initial conditons
nyears <- 110

sable_om <- readRDS("data/sablefish_om_big.RDS") # Read this saved OM from a file
sable_om$model_options$fleet_apportionment <- matrix(c(0.80, 0.20), nrow=nrow(sable_om$model_options$fleet_apportionment), ncol=2, byrow=TRUE)

source("dev/oms.R")
om_list <- listN(
    om_rand_recruit,
    om_cylic_recruit,
    om_bh_recruit,
    om_low_recruit,
    om_high_recruit, 
    om_crash_recruit,
    om_bhcyclic_recruit
)


#' 2. Define a harvest control rule (HCR) function to use to project TAC
#' in future years. Such function must take accept the following parameters:
#' ref_pts: a list of reference points as generated by `calculate_ref_points`,
#'          (Fref and Bref)
#' naa: a vector of numbers-at-age for a given year (should be [1, nages, nsexes, nregions])
#' dem_params: a list of demographic parameter values subsetted to a single year
#' 
#' HCR functions can accept as many additional parameters as required.
#' 
#' Below is an example implementation of the NPFMCs Tier 3a HCR     
source("dev/hcrs.R")

hcr_list <- listN(
    mp_f40, 
    mp_b30f40, 
    mp_b30f50, 
    mp_b40f50, 
    mp_b40f55, 
    mp_f50, 
    mp_f40cons,
    mp_10cap,
    mp_15cap,
    mp_20cap,
    mp_20cap_cons,
    mp_25cap,
    mp_25cap_cons,
    mp_10perc,
    mp_15perc,
    mp_25perc,
    mp_f50chr,
    mp_f55chr,
    mp_f00chr,
    mp_agedevs,
    mp_ageblocks,
    mp_ageswitch,
    mp_pfmc4010
)

#' 3. Run the closed-loop MSE simulation
#' A single MSE simulation can be run using the `run_mse(...)`
#' function, while multiple MSE simulations can be run (serially)
#' using the `run_mse_multiple(...)` function.
#' 
#' It is recommended to always use `run_mse_multiple(...)` even
#' when only a single MSE simulation is required.
# om_list = listN(om1, om2)
# hcr_list = listN(mp1, mp2, mp3, mp5, mp8, mp9, mp10, mp12, mp13, mp15)
# hcr_list <- listN(mp1)

# 857, 1120, 1007, 895
set.seed(895)
nsims <- 9
seed_list <- sample(1:(1000*nsims), nsims)  # Draw 10 random seeds
seed_list <- c(3,40,311,417,1105,1259,1581,1819,2078,2330,2512,2563,2719,2861,3190,3452,3709,3899,4233,4716,4723,4852,5160,5938,6264,6533,6754,7149,7207,7284,7329,7557,7579,8003,8388,8904)#ssb_data2 %>% pull(sim) %>% unique


mse_options_base <- setup_mse_options()
mse_options <- mse_options_base
mse_options$n_spinup_years <- 54
mse_options$recruitment_start_year <- 54
mse_options$n_proj_years <- 75

mse_options_list <- listN(mse_options)#, mse_options2, mse_options3)


om_list <- listN(om_rand_recruit, om_crash_recruit, om_bhcyclic_recruit)
hcr_list <- listN(mp_f40, mp_f40chr, mp_f50chr, mp_f55chr)

# mp5_modelrun <- run_mse_parallel(nsims, seed_list, om1, mp5, mse_options, nyears)
tic()
model_runs <- run_mse_multiple(
    om_list, 
    hcr_list, 
    seed_list,
    nyears=100,
    mse_options_list=mse_options_list,
    diagnostics = TRUE
)

toc()

filter_hcrs <- function(data, hcr_type){
    return(
        data %>% mutate(
            hcr_class = case_when(
                grepl("Harvest Cap", hcr) ~ "Harvest Cap",
                grepl("Age", hcr) ~ "Age Structured",
                grepl("+/-", hcr) ~ "Stability Constraints",
                TRUE ~ "Reference Points"
            )
        ) %>%
        filter(hcr_class == hcr_type | hcr == "F40")
    )
}

hcr_groups <- c("Harvest Caps", "Age Structured", "Stability Constraints", "Constant F", "Reference Points")

om_names <- unlist(lapply(om_list, \(x) x$name))
hcr_names <- unlist(lapply(hcr_list, \(x) x$name))

extra_columns2 <- expand.grid(
    om = unlist(lapply(om_list, \(x) x$name)),
    hcr = unlist(lapply(hcr_list, \(x) x$name))
) %>% as_tibble() %>%
as.data.frame

mse_runs <- get_saved_model_runs(om_order=om_names, hcr_order=hcr_names)
model_runs <- mse_runs$model_runs
extra_columns2 <- mse_runs$extra_columns2

interval_widths <- c(0.50, 0.80)
common_trajectory <- 54

# model_runs <- mse_runs$model_runs
plot_mse_summary(model_runs, extra_columns2, dem_params=sable_om$dem_params, hcr_filter=publication_hcrs, om_filter=om_names, common_trajectory = common_trajectory)+custom_theme
ggsave(filename=file.path("~/Desktop/", "summary2.png"), width=10, height=7, units="in")

# Plot spawning biomass
ssb_data <- get_ssb_biomass(model_runs, extra_columns2, sable_om$dem_params, hcr_filter=publication_hcrs, om_filter=om_names)
plot_ssb(ssb_data, v1="hcr", v2="om", v3=NA, common_trajectory=common_trajectory, show_est = FALSE)+custom_theme+guides(color=guide_legend(title="HCR", nrow=4))

nofish_ssbb_data <- ssb_data %>% filter(hcr == "No Fishing")
rel_ssb <- ssb_data %>% left_join(nofish_ssbb_data, by=c("time", "sim", "L1", "om"), suffix=c("", ".nofish")) %>%
    filter(time > common_trajectory) %>%
    mutate(
        rel_ssb = spbio/spbio.nofish
    ) %>%
    filter(L1 == "naa", hcr %in% publication_hcrs) %>%
    group_by(time, om, hcr) %>%
    median_qi(rel_ssb, .width=interval_widths)

ggplot(rel_ssb) +
    geom_line(aes(x=time, y=rel_ssb, color=hcr, group=hcr), size=0.85)+
    scale_y_continuous(limits=c(0, 1))+
    facet_wrap(~om)+
    custom_theme

ggsave(filename=file.path("~/Desktop/sablefish_plots", "ssb.png"), width=8, height=8, units=c("in"))


# Plot fishing mortality rates from OM and EM
f_data <- get_fishing_mortalities(model_runs, extra_columns2, hcr_filter=publication_hcrs, om_filter=om_names)
plot_fishing_mortalities(f_data, v1="hcr", v2="om", common_trajectory = common_trajectory, show_est=TRUE)+custom_theme
ggsave(filename=file.path("~/Desktop/sablefish_plots", "fishing_mortality.png"), width=8, height=8, units=c("in"))

# Plot management quantities (ABC, TAC, Expected Landings, and Attainment)
abctac <- get_management_quantities(model_runs, extra_columns2, spinup_years=common_trajectory, hcr_filter=publication_hcrs, om_filter=om_names)
plot_abc_tac(abctac, v1="hcr", v2="om", common_trajectory=common_trajectory)+custom_theme
ggsave(filename=file.path("~/Desktop/sablefish_plots", "abc_tac.png"), width=10*1.7, height=6*1.7, units=c("in"))

abctac %>% filter(time > 64) %>%
    group_by(om, hcr, L1) %>%
    median_qi(value, .width=c(0.50)) %>%
    select(om, hcr, L1, value) %>%
    filter(L1 %in% c("ABC")) %>%
    pivot_wider(names_from=hcr, values_from=value) %>%
# Plot landed catch
catch_data <- get_landed_catch(model_runs, extra_columns2, hcr_filter=publication_hcrs, om_filter=om_names)
plot_landed_catch(catch_data, v1="hcr", v2="om", common_trajectory = common_trajectory)+custom_theme
ggsave(filename=file.path("~/Desktop/sablefish_plots", "catch.png"), width=8, height=8, units=c("in"))

for(g in hcr_groups){
    plot_ssb_catch(
        model_runs, extra_columns2, sable_om$dem_params, 
        v1="hcr", v2="om", v3=NA, common_trajectory = common_trajectory,
        hcr_filter = publication_hcrs
    )+custom_theme
    ggsave(filename=file.path("~/Desktop/sablefish_plots", paste0("ssb_catch_", g ,".png")), width=13, height=10, units=c("in"))
}

# Plot phase-plane diagrams (F vs SSB, HCR v SSB, Catch v SSB)
ref_pts <- get_reference_points(model_runs, extra_columns2, om_list, hcr_list, seed_list)

phaseplane_data <- get_phaseplane_data(model_runs, extra_columns2, sable_om$dem_params)
phaseplane_data2 <- phaseplane_data
plot_phase_diagram(phaseplane_data2, ref_pts, common_trajectory = common_trajectory)+custom_theme

hcrphase_data <- get_hcrphase_data(model_runs, extra_columns2, sable_om$dem_params)
hcrphase_data2 <- hcrphase_data
plot_hcr_phase_diagram(hcrphase_data2, ref_pts, common_trajectory = common_trajectory)+custom_theme

catchphase_data <- get_phaseplane_catch_data(model_runs, extra_columns2, sable_om$dem_params)
plot_catch_phase_diagram(catchphase_data, ref_pts, common_trajectory = common_trajectory)+custom_theme

# Plot recruitment
rec_data <- get_recruits(model_runs, extra_columns2)
plot_recruitment(rec_data, v1="hcr", v2="om", show_est = FALSE)

###### Performance Metrics
time_horizon <- c(55, 135)

performance_metrics <- performance_metric_summary(
    model_runs, 
    extra_columns2, 
    sable_om$dem_params, 
    ref_naa,
    interval_widths=c(0.50, 0.80),
    time_horizon = time_horizon, 
    extra_filter = NULL,
    relative=NULL, 
    summarise_by=c("om", "hcr")
)

# perf_data <- performance_metrics$perf_data %>% filter(hcr %in% publication_hcrs)
perf_data2 <- perf_data %>% filter(hcr %in% publication_hcrs)
plot_performance_metric_summary(perf_data2, v2="om", is_relative=FALSE)+custom_theme+guides(color="none", shape="none")
ggsave(filename=file.path("~/Desktop", "performance.png"), width=16, height=18, units=c("in"))

performance_metrics
ggplot(perf_data) + 
    geom_point(aes(y=hcr, x=median, color=om, shape=om), size=3)+
    facet_wrap(~name, scales="free_x")+
    theme_bw()+
    custom_theme

om_summ <- perf_data %>% filter(.width == 0.50) %>% 
    group_by(om, name) %>% 
    summarise(value = mean(median))

perf_data %>% filter(.width == 0.50) %>%
    left_join(om_summ, by=c("om", "name")) %>%
    mutate(
        distance = median - value
    ) %>%
    group_by(hcr, name) %>%
    summarise(
        avg = mean(distance)/mean(value)
    ) %>%
    pivot_wider(names_from="name", values_from="avg")



















caa_groups <- get_atage_groups(
    model_runs, 
    extra_columns2, 
    hcr_filter=publication_hcrs,
    om_filter=om_names,
    q="caa",
    age_groups=c(5, 9, 14), 
    group_names = c("Small", "Medium", "Large"),
    group_abbs = c("S", "M", "L"),
    summarise = TRUE,
    make_segments = TRUE
)
col_names = c("S", "M", "L")
plot_atage_trajectory_ternary(caa_groups$data, caa_groups$segments, col_names)

caa_groups$data %>% group_by(hcr, om) %>%
    median_qi(L, .width=c(0.50)) %>%
    print(n=100)

caa_groups2 <- get_atage_groups(
    model_runs, 
    extra_columns2, 
    hcr_filter=publication_hcrs,
    om_filter=om_names,
    q="caa",
    age_groups=c(5, 9, 14), 
    group_names = c("Small", "Medium", "Large"),
    group_abbs = c("S", "M", "L"),
    summarise = FALSE,
    make_segments = FALSE
)
plot_atage_density_ternary(caa_groups2, col_names = c("S", "M", "L"))+custom_theme
ggsave(filename=file.path("~/Desktop/sablefish_plots", "caa_tern.png"), width=8*1.7, height=6*1.7, units=c("in"))

naa_groups <- get_atage_groups(
    model_runs,
    extra_columns2,
    hcr_filter=publication_hcrs,
    om_filter=om_names,
    q="naa",
    age_groups=c(7, 14, 21),
    group_names=c("Young", "Adult", "Old"),
    group_abbs = c("Y", "A", "O"),
    summarise=FALSE,
    make_segments = FALSE
)
col_names = c("Y", "A", "O")
plot_atage_density_ternary(d=naa_groups, col_names=col_names)+custom_theme
ggsave(filename=file.path("~/Desktop/sablefish_plots", "naa_tern.png"), width=8*1.7, height=6*1.7, units=c("in"))


filter_string <- get_big_recruitment_filter(
    om_list, 
    seed_list, 
    model_runs, 
    unlist(lapply(om_list, \(x) x$name)), 
    large_event_thresh = 60, 
    lags=c(8, 14)
)


# Example recruitment functions
examp_rec <- get_recruits(model_runs, extra_columns2) %>%
    as_tibble() %>%
    filter(time > 54, sim %in% sample(seed_list, 5), hcr == "F40") %>%
    mutate(
        sim = factor(sim)
    )

mean_rec <- examp_rec %>%
    group_by(om) %>%
    summarise(r=mean(rec))

summ_rec <- get_recruits(model_runs, extra_columns2) %>%
    as_tibble() %>%
    filter(time > 54, hcr == "F40") %>%
    group_by(time, om) %>%
    median_qi(rec, .width=interval_widths)

ggplot(examp_rec) +
    geom_line(aes(x=time, y=rec, color=om, group=sim), size=0.5, alpha=0.6)+
    geom_line(data=summ_rec, aes(x=time, y=rec), color="black")+
    # geom_line(data=summ_rec, aes(x=time, y=.lower), linetype="dashed", color="black")+
    # geom_line(data=summ_rec, aes(x=time, y=.upper), linetype="dashed", color="black")+
    geom_hline(data=mean_rec, aes(yintercept=r), linetype="dashed")+
    geom_text(data=mean_rec, aes(x=123, y=110, label=round(r, 2)), size=6)+
    scale_y_continuous(limits=c(0, 120))+
    scale_x_continuous(breaks=c(seq(55, 130, 20), 134), labels=c(seq(0, 75, 20), 75))+
    guides(color="none")+
    labs(x="Time", y="Recruitment")+
    coord_cartesian(expand=0)+
    facet_wrap(~om, ncol=2)+
    theme_bw()+
    custom_theme
ggsave(filename=file.path("~/Desktop", "example_recruitment.png"), width=13, height=10, units = "in")

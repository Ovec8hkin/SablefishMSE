rm(list=ls())

library(ggdist)
library(ggh4x)
library(reshape2)

# library(afscOM) # may work but not certain

# Change to wherever your local copy of afscOM is
library(devtools)
afscOM_dir <- "~/Desktop/Projects/afscOM" 
devtools::load_all(afscOM_dir)

source("R/reference_points.R")
source("R/harvest_control_rules.R")
source("R/simulate_TAC.R")
source("R/age_structure_stats.R")
source("R/data_utils.R")
source("R/data_processing.R")
source("R/run_mse.R")
source("R/run_mse_multiple.R")
source("R/format_em_data.R")
source("R/fit_TMB_model.R")

#' 1. Set up the OM by defining demographic parameters
#' model options (such as options governing the observation
#' processes), and OM initial conditons
sable_om <- readRDS("data/sablefish_om.RDS") # Read this saved OM from a file
sable_om$model_options$simulate_observations <- TRUE # Enable simulating observations
# Generated 50 age composition samples from the LL survey and fixed gear fishery
sable_om$model_options$obs_pars$surv_ll$ac_samps <- 50
sable_om$model_options$obs_pars$surv_tw$ac_samps <- 50
sable_om$model_options$obs_pars$fish_fx$ac_samps <- 50
# Generate age comp samples as integers rather than proportions
# (this is necesarry for the SpatialSablefishAssessment TMB model)
sable_om$model_options$obs_pars$surv_ll$as_integers = TRUE
sable_om$model_options$obs_pars$surv_tw$as_integers = TRUE
sable_om$model_options$obs_pars$fish_fx$as_integers = TRUE

#' 2. Define a harvest control rule (HCR) function to use to project TAC
#' in future years. Such function must take accept the following parameters:
#' ref_pts: a list of reference points as generated by `calculate_ref_points`,
#'          (B40, F35, and F40)
#' naa: a vector of numbers-at-age for a given year (should be [1, nages, nsexes, nregions])
#' dem_params: a list of demographic parameter values subsetted to a single year
#' 
#' HCR functions can accept as many additional parameters as required.
#' 
#' Below is an example implementation of the NPFMCs Tier 3a HCR     
tier3 <- function(ref_pts, naa, dem_params){
    ssb <- apply(naa[,,1,]*dem_params$waa[,,1,,drop=FALSE]*dem_params$mat[,,1,,drop=FALSE], 1, sum)
    return(
        npfmc_tier3_F(ssb, ref_pts$B40, ref_pts$F40)
    )
}

#' 3. Run the closed-loop MSE simulation
#' A single MSE simulation can be run using the `run_mse(...)`
#' function, while multiple MSE simulations can be run (serially)
#' using the `run_mse_multiple(...)` function.
#' 
#' It is recommended to always use `run_mse_multiple(...)` even
#' when only a single MSE simulation is required.
set.seed(1120)
nsims <- 10
seeds <- sample(1:(1000*nsims), nsims)  # Draw 10 random seeds

mse_tier3     <- run_mse_multiple(nsims=nsims, seeds=seeds, nyears=100, om=sable_om, hcr=tier3)

# Example of running a single MSE simulation
# mse_tier3     <- run_mse(om=sable_om, hcr=tier3, nyears_input=100)

#' 4. Process MSE results
#' An example processing routine to plot the OM spawning biomass,
#' aggregated over multiple simulations, alongside the EM estimate
#' of spawning biomass.
model_runs <- list(
    mse_tier3
)
extra_columns <- list(
    hcr = c("tier3_3")
)

# `bind_mse_outputs` creates a long-format tibble containing
# the data from the `naa` and `naa_est` MSE output array for
# each of the simulations.
d <- bind_mse_outputs(model_runs, c("naa", "naa_est"), extra_columns) %>% 
    as_tibble() %>%
    drop_na() %>%
    # join WAA and maturity-at-age for computing SSB
    left_join(
        melt(sable_om$dem_params$waa, value.name="weight"), 
        by=c("time", "age", "sex")
    ) %>%
    left_join(
        melt(sable_om$dem_params$mat, value.name="maturity"), 
        by=c("time", "age", "sex")
    ) %>%
    drop_na() %>%
    # compute derived quantities
    mutate(
        biomass = value*weight,
        spbio = value*weight*maturity
    ) %>%
    # SSB is females only
    filter(sex == "F") %>%
    # summarise SSB across year and sim 
    group_by(time, hcr, sim, L1) %>%
    summarise(spbio=sum(spbio)) %>%
    # Compute quantiles of SSB distribution
    group_by(time, hcr, L1) %>%
    median_qi(spbio, .width=c(0.50, 0.80), .simple_names=FALSE) %>%
    # Reformat ggdist tibble into long format
    reformat_ggdist_long(n=3)


ggplot(d %>% filter(L1 == "naa")) + 
    geom_lineribbon(aes(x=time, y=median, ymin=lower, ymax=upper, group=hcr), size=0.4)+
    geom_pointrange(data = d %>% filter(L1 == "naa_est", time > 63), aes(x=time, y=median, ymin=lower, ymax=upper), alpha=0.35, color="red")+
    geom_vline(xintercept=64, linetype="dashed")+
    scale_fill_brewer(palette="Blues")+
    scale_y_continuous(limits=c(0, 300))+
    coord_cartesian(expand=0)+
    theme_bw()
